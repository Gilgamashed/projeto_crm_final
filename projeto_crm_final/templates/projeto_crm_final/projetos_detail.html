{% extends 'projeto_crm_final/base.html' %}
{% load widget_tweaks %}
{% block title %}{{ projeto.name|capfirst }}{% endblock %}
{% block content %}

<style>
/* Status colors */
.status-active { color: #28a745; }
.status-overdue { color: #dc3545; font-weight: bold; }
.status-canceled { color: #6c757d; }
.status-done { color: #007bff; }
.status-pending { color: #ffc107; }

/* prioridade */
.badge-priority-urgente { background-color: #dc3545; color: white; }
.badge-priority-alta { background-color: #ffc107; color: black; }
.badge-priority-baixa { background-color: #0dcaf0; color: black; }
.badge-priority-regular { background-color: #6c757d; color: white; }

.task-card {
    border-left: 4px solid;
    transition: all 0.3s ease;
}
.task-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.task-urgente { border-left-color: #dc3545; }
.task-alta { border-left-color: #ffc107; }
.task-regular { border-left-color: #6c757d; }
.task-baixa { border-left-color: #0dcaf0; }
.task-status {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border-radius: 3px;
}
.status-parafazer { background-color: #e9ecef; color: #495057; }
.status-fazendo { background-color: #fff3cd; color: #856404; }
.status-feito { background-color: #d4edda; color: #155724; }
.task-assignee {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.8rem;
}

</style>

<!-- card principal -->
<div class="container mt-5">
  <div class="card">
    <div class="card-header">
      <h1>{{ projeto.name|capfirst }} -
      <span class="status-{{ projeto.status|lower }}">{{ projeto.get_status_display }}</span>
      </h1>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <p class="badge bg-light text-dark"><strong>{{ projeto.get_categoria_display }}</strong></p>
          <p><strong>Iniciado por:</strong> {{ projeto.criador.nome|capfirst }} {{ projeto.criador.sobrenome|capfirst }}</p>

          <p><strong>Prioridade:</strong>
            <span class="badge
              {% if projeto.prioridade == 'urgente' %}bg-danger
              {% elif projeto.prioridade == 'alta' %}bg-warning
              {% elif projeto.prioridade == 'regular' %}bg-info
              {% elif projeto.prioridade == 'baixa' %}bg-info
              {% else %}bg-secondary
              {% endif %}">
              {{ projeto.get_prioridade_display }}
            </span>
          </p>

          <p> {{projeto.descricao}}</p>
        </div>
        <div class="col-md-6">
          <p><strong>Equipe:</strong> {{ projeto.equipe|default:"Aguardando..." }}</p>
          <p><strong>Iniciado:</strong> {{ projeto.inicio }}</p>
          <p><strong>Prazo:</strong> {{ projeto.prazofinal }}</p>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">

          <!-- area do criador -->
        </div>
        {% if projeto.criador == request.user.integrantes %}
        <div class="col-md-6">
          <a href="{% url 'projetos_edit' projeto.pk %}" class="btn btn-warning btn-sm">
            Atualizar projeto
          </a> <button class="btn btn-danger btn-sm"
                       data-bs-toggle="modal"
                       data-bs-target="#modalExcluir"
                       data-id="{{ projeto.pk }}"
                       data-name="{{ projeto.name }}">
            Cancelar projeto
          </button>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="mt-4">
    <a href="{% url 'dashboard' %}" class="btn btn-primary">
      Voltar à sua home
    </a><span> <a href="{% url 'projetos_list' %}" class="btn btn-primary">
      Voltar à lista de projetos
    </a></span>
  </div>
</div>

<!-- Card de tarefas -->
<div class="container mt-5">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2>Tarefas</h2>
            <!-- area de lider e admin -->
            {% if can_create %}
            <button class="btn btn-success btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#modalAdicionarTarefa">
                <i class="bi bi-plus-circle"></i> Nova Tarefa
            </button>
            {% endif %}
        </div>
        <div class="card-body">
            {% if tarefas %}
            <div class="row">
                {% for tarefa in tarefas %}
                <div class="col-md-6 mb-3">
                    <div class="card task-card task-{{ tarefa.prioridade }}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <h5 class="card-title">{{ tarefa.name }}</h5>
                                <span class="task-status status-{{ tarefa.status }}">
                                    {{ tarefa.get_status_display }}
                                </span>
                            </div>
                            <p class="card-text">{{ tarefa.descricao|truncatechars:100 }}</p>

                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="me-2">
                                        <i class="bi bi-person"></i>
                                        {% if tarefa.responsavel %}
                                            {{ tarefa.responsavel.nome }}
                                        {% else %}
                                            Não atribuído
                                        {% endif %}
                                    </span>
                                    <span>
                                        <i class="bi bi-calendar"></i>
                                        {{ tarefa.prazofinal|date:"d/m/Y" }}
                                    </span>
                                </div>

                                <!-- Edição apenas pra lider/admin -->
                                {% if can_create %}
                                <div>
                                    <button class="btn btn-sm btn-outline-primary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#modalEditarTarefa"
                                            data-id="{{ tarefa.id }}"
                                            data-name="{{ tarefa.name }}"
                                            data-descricao="{{ tarefa.descricao }}"
                                            data-responsavel="{{ tarefa.responsavel.person_id|default:'' }}"
                                            data-prazo="{{ tarefa.prazofinal|date:'Y-m-d' }}"
                                            data-prioridade="{{ tarefa.prioridade }}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info">
                Nenhuma tarefa criada ainda.
                {% if can_create %}
                Clique em "Nova Tarefa" para adicionar.
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal excluir projeto -->
<div class="modal fade" id="modalExcluir" tabindex="-1" aria-labelledby="modalExcluirLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
    <form method="post" id="formExclusao">
      {% csrf_token %}
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="modalExcluirLabel">Confirmar Cancelamento</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Tem certeza que deseja abortar o projeto <strong id="projetoName"></strong>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        <button type="submit" class="btn btn-danger">Confirmar</button>
      </div>
    </form>
    </div>
  </div>
</div>

<!-- Modal adicionar tarefa -->
<div class="modal fade" id="modalAdicionarTarefa" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'tarefas_create' projeto.pk %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Adicionar Nova Tarefa</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Título</label>
            <input type="text" name="name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Descrição</label>
            <textarea name="descricao" class="form-control" rows="3"></textarea>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Responsável</label>
              <select name="responsavel" class="form-select">
                    <option value="">Não atribuído</option>
                    {% if projeto.equipe %}
                        {% for membro in projeto.equipe.membros.all %}
                            <!-- Add selected attribute if current user -->
                            <option value="{{ membro.person_id }}"
                                {% if membro == request.user.integrantes %}selected{% endif %}>
                                {{ membro.nome }} {{ membro.sobrenome }}
                            </option>
                        {% endfor %}
                    {% endif %}
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Prazo Final</label>
              <input type="date" name="prazofinal" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Prioridade</label>
              <select name="prioridade" class="form-select">
                {% for choice in PRIORIDADE %}
                <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar Tarefa</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal editar tarefa -->
<div class="modal fade" id="modalEditarTarefa" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Editar Tarefa</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="tarefa_id" id="editTarefaId">
          <div class="mb-3">
            <label class="form-label">Título</label>
            <input type="text" name="name" id="editName" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Descrição</label>
            <textarea name="descricao" id="editDescricao" class="form-control" rows="3"></textarea>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Responsável</label>
              <select name="responsavel" id="editResponsavel" class="form-select">
                <option value="">Não atribuído</option>
                {% if projeto.equipe %}
                    {% for membro in projeto.equipe.membros.all %}
                        <!-- Add selected attribute if current user -->
                        <option value="{{ membro.person_id }}"
                            {% if membro == request.user.integrantes %}selected{% endif %}>
                            {{ membro.nome }} {{ membro.sobrenome }}
                        </option>
                    {% endfor %}
                {% endif %}
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Prazo Final</label>
              <input type="date" name="prazofinal" id="editPrazo" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Prioridade</label>
              <select name="prioridade" id="editPrioridade" class="form-select">
                {% for choice in PRIORIDADE %}
                <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Atualizar Tarefa</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
    // modalExcluir
    const modalExcluir = document.getElementById('modalExcluir');
    const projetoName = document.getElementById('projetoName');
    const formExclusao = document.getElementById('formExclusao');

    modalExcluir.addEventListener('show.bs.modal', function(event) {
        const botaoExcluir = event.relatedTarget;
        const projetoId = botaoExcluir.getAttribute('data-id');
        const name = botaoExcluir.getAttribute('data-name');

        projetoName.textContent += name;
        formExclusao.action = `/projetos/${projetoId}/excluir/`;
    });

      // Editar Tarefa modal
    const editTaskModal = document.getElementById('modalEditarTarefa');
    editTaskModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;

        // Extrair innformaçao de tarefas
        const tarefaId = button.getAttribute('data-id');
        const name = button.getAttribute('data-name');
        const descricao = button.getAttribute('data-descricao');
        const responsavel = button.getAttribute('data-responsavel');
        const prazo = button.getAttribute('data-prazo');
        const prioridade = button.getAttribute('data-prioridade');

        // Update form modal
        document.getElementById('editTarefaId').value = tarefaId;
        document.getElementById('editName').value = name;
        document.getElementById('editDescricao').value = descricao;
        document.getElementById('editResponsavel').value = responsavel;
        document.getElementById('editPrazo').value = prazo;
        document.getElementById('editPrioridade').value = prioridade;

        // Update form URL
        const form = editTaskModal.querySelector('form');
        form.action = `/tarefas/editar/${tarefaId}/`;
    });
</script>


{% endblock %}